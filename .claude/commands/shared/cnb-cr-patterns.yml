# CNB Code Review Patterns and Workflows
# Configuration for /cnb-cr command implementation
#
# MCP Dependencies:
#   - CNB MCP Server: mcp__cnb__* tools for CNB platform integration
#   - WeChat Work MCP Server: mcp__wecom__* tools for team notifications
#
# Required Permissions:
#   - CNB platform access and authentication
#   - WeChat Work webhook configuration
#   - Local file system access for repository management

CNB_CR_Core:
  Repository_Management:
    base_path: "~/Coding/cnb-cr/repos"
    clone_strategy: "if_not_exists"
    update_strategy: "pull_latest"
    cleanup_policy: "keep_recent_branches"
    
  URL_Parsing:
    pattern: "https://cnb.tmeoa.com/{group}/{repo}/-/pulls/{number}"
    extract:
      - group: "URLè·¯å¾„ä¸­çš„ç»„ç»‡å"
      - repo: "ä»“åº“åç§°"  
      - number: "PRç¼–å·"
      
  Branch_Management:
    target_branch: "è·å–PRçš„ç›®æ ‡åˆ†æ”¯"
    source_branch: "è·å–PRçš„æºåˆ†æ”¯"
    diff_strategy: "git diff {target}..{source}"

CNB_CR_Workflow:
  Step_1_Parse_URL:
    description: "è§£æCNB PRé“¾æ¥æå–ä¿¡æ¯"
    extract_fields:
      - repo_group
      - repo_name  
      - pr_number
    validation: "ç¡®ä¿URLæ ¼å¼æ­£ç¡®"
    
  Step_2_Get_PR_Info:
    description: "è°ƒç”¨CNB MCPè·å–PRè¯¦ç»†ä¿¡æ¯"
    mcp_tool: "mcp__cnb__get-pull"
    required_params:
      repo: "{group}/{repo}"
      number: "{pr_number}"
    extract_data:
      - title: "PRæ ‡é¢˜"
      - author: "ä½œè€…ä¿¡æ¯"
      - description: "PRæè¿°"
      - base_branch: "ç›®æ ‡åˆ†æ”¯"
      - head_branch: "æºåˆ†æ”¯"
      - changed_files: "å˜æ›´æ–‡ä»¶æ•°é‡"
      - additions: "æ–°å¢è¡Œæ•°"
      - deletions: "åˆ é™¤è¡Œæ•°"
      
  Step_3_Repository_Management:
    description: "ç®¡ç†æœ¬åœ°ä»“åº“å…‹éš†å’Œæ›´æ–°"
    local_path: "~/Coding/cnb-cr/repos/{repo_name}"
    operations:
      check_exists: 
        - "æ£€æŸ¥æœ¬åœ°ä»“åº“ç›®å½•æ˜¯å¦å­˜åœ¨"
        - "ls ~/Coding/cnb-cr/repos/{repo_name}"
      if_exists:
        - "cd ~/Coding/cnb-cr/repos/{repo_name}"
        - "git fetch origin"
        - "git checkout {base_branch}"
        - "git pull origin {base_branch}"
      if_not_exists:
        - "mkdir -p ~/Coding/cnb-cr/repos"
        - "cd ~/Coding/cnb-cr/repos"
        - "git clone {clone_url} {repo_name}"
        - "cd {repo_name}"
        
  Step_4_Get_PR_Changes:
    description: "è·å–PRçš„å…·ä½“ä»£ç å˜æ›´"
    git_operations:
      fetch_pr: "git fetch origin pull/{pr_number}/head:pr-{pr_number}"
      checkout_base: "git checkout {base_branch}"
      get_diff: "git diff {base_branch}..pr-{pr_number}"
      get_changed_files: "git diff {base_branch}..pr-{pr_number} --name-only"
      get_stats: "git diff {base_branch}..pr-{pr_number} --stat"
      
  Step_5_Code_Analysis:
    description: "ä½¿ç”¨SuperClaudeèƒ½åŠ›åˆ†æä»£ç å˜æ›´"
    analysis_dimensions:
      logic_check:
        focus: "æ½œåœ¨bugå’Œé€»è¾‘æ¼æ´"
        tools: ["/review --files {changed_files} --quality"]
        severity_levels: ["critical", "high", "medium", "low"]
        
      style_check:
        focus: "ç¼–ç è§„èŒƒå’Œé£æ ¼ä¸€è‡´æ€§"
        tools: ["/scan --quality --validate"]
        standards: ["é¡¹ç›®ç°æœ‰è§„èŒƒ", "è¯­è¨€æœ€ä½³å®è·µ"]
        
      readability_check:
        focus: "ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§"
        tools: ["/analyze --code --architecture"]
        criteria: ["æ¸…æ™°åº¦", "æ³¨é‡Šå®Œæ•´æ€§", "æ¨¡å—åŒ–"]
        
      performance_check:
        focus: "æ€§èƒ½å½±å“å’Œä¼˜åŒ–å»ºè®®"
        tools: ["/analyze --profile --persona-performance"]
        areas: ["ç®—æ³•æ•ˆç‡", "èµ„æºä½¿ç”¨", "ç“¶é¢ˆè¯†åˆ«"]
        
      test_check:
        focus: "æµ‹è¯•è¦†ç›–å’Œè´¨é‡"
        tools: ["/test --coverage --validate"]
        requirements: ["å•å…ƒæµ‹è¯•", "é›†æˆæµ‹è¯•", "è¾¹ç•Œæµ‹è¯•"]
        
  Step_6_Generate_Report:
    description: "ç”Ÿæˆç»“æ„åŒ–çš„CRæŠ¥å‘Š"
    report_template: |
      ğŸ“‹ ä»£ç è¯„å®¡æŠ¥å‘Š
      PR: {title} (#{number})
      ä½œè€…: {author}
      åˆ†æ”¯: {head_branch} â†’ {base_branch}
      å˜æ›´: +{additions}è¡Œ -{deletions}è¡Œ ({changed_files_count}ä¸ªæ–‡ä»¶)
      
      ğŸ” è¯„å®¡ç»“æœï¼š
      âœ… é€šè¿‡é¡¹ç›®: {pass_count}ä¸ª
      âš ï¸  éœ€è¦å…³æ³¨: {warning_count}ä¸ª  
      âŒ å¿…é¡»ä¿®å¤: {critical_count}ä¸ª
      
      ğŸ“ è¯¦ç»†å»ºè®®ï¼š
      {detailed_suggestions}
      
      ğŸ¯ æ€»ç»“ï¼š{overall_assessment}
      
      ğŸ”— PRé“¾æ¥: {pr_url}
      â° è¯„å®¡æ—¶é—´: {timestamp}
      
    categorization:
      pass_criteria: "æ— é‡å¤§é—®é¢˜ï¼Œä»£ç è´¨é‡è‰¯å¥½"
      warning_criteria: "å­˜åœ¨å¯æ”¹è¿›ç‚¹ï¼Œä½†ä¸é˜»å¡åˆå¹¶"
      critical_criteria: "å­˜åœ¨ä¸¥é‡é—®é¢˜ï¼Œå¿…é¡»ä¿®å¤åæ‰èƒ½åˆå¹¶"
      
  Step_7_User_Confirmation:
    description: "ç­‰å¾…ç”¨æˆ·ç¡®è®¤è¯„å®¡ç»“æœ"
    display_format: "å®Œæ•´çš„CRæŠ¥å‘Š"
    confirmation_prompt: "è¯·ç¡®è®¤æ˜¯å¦åŒæ„æ­¤è¯„å®¡ç»“æœå¹¶æäº¤è¯„è®ºåˆ°PRï¼Ÿ(y/n)"
    options:
      - "y/yes: ç¡®è®¤å¹¶æäº¤è¯„è®º"
      - "n/no: å–æ¶ˆæ“ä½œ"
      - "edit: ä¿®æ”¹è¯„è®ºå†…å®¹"
      
  Step_8_Submit_Comment:
    description: "æäº¤è¯„è®ºåˆ°CNB PR"
    condition: "ç”¨æˆ·ç¡®è®¤åŒæ„"
    mcp_tool: "mcp__cnb__create-pull-comment"
    params:
      repo: "{group}/{repo}"
      number: "{pr_number}"
      body: "{formatted_cr_comment}"
    comment_format: |
      ## ğŸ” ä»£ç è¯„å®¡æŠ¥å‘Š
      
      ### ğŸ“Š è¯„å®¡æ‘˜è¦
      - âœ… é€šè¿‡: {pass_count}é¡¹
      - âš ï¸ å…³æ³¨: {warning_count}é¡¹  
      - âŒ ä¿®å¤: {critical_count}é¡¹
      
      ### ğŸ“ è¯¦ç»†å»ºè®®
      {detailed_feedback}
      
      ### ğŸ¯ æ€»ä½“è¯„ä»·
      {overall_summary}
      
      ---
      *è¯„å®¡æ—¶é—´: {timestamp}*
      
  Step_9_WeChat_Notification:
    description: "å‘é€WeChat Workå›¢é˜Ÿé€šçŸ¥"
    condition: "è¯„è®ºæäº¤æˆåŠŸä¸”æœªè®¾ç½®--no-wecom"
    mcp_tool: "mcp__wecom__send_wecom_message"
    params:
      message_type: "markdown"
      content: "{wecom_notification}"
    notification_template: |
      ğŸ”„ **ä»£ç è¯„å®¡å®Œæˆ**
      
      ğŸ“‹ **{repo_name}** PR#{number}
      ğŸ‘¤ ä½œè€…: {author}
      ğŸ“ æ ‡é¢˜: {title}
      
      ğŸ“Š è¯„å®¡ç»“æœ: âœ…{pass_count} âš ï¸{warning_count} âŒ{critical_count}
      
      ğŸ”— [æŸ¥çœ‹è¯¦æƒ…]({pr_url})
      ğŸ“… {timestamp}

Review_Quality_Standards:
  Code_Logic:
    critical_issues:
      - "ç©ºæŒ‡é’ˆå¼•ç”¨"
      - "æ•°ç»„è¶Šç•Œ"
      - "æ­»å¾ªç¯é£é™©"
      - "èµ„æºæ³„éœ²"
    high_issues:
      - "é€»è¾‘ä¸ä¸€è‡´"
      - "è¾¹ç•Œæ¡ä»¶æœªå¤„ç†"
      - "å¼‚å¸¸å¤„ç†ç¼ºå¤±"
    medium_issues:
      - "ä»£ç é‡å¤"
      - "å¤æ‚åº¦è¿‡é«˜"
      - "å‘½åä¸è§„èŒƒ"
      
  Security_Check:
    critical_issues:
      - "SQLæ³¨å…¥é£é™©"
      - "XSSæ¼æ´"
      - "èº«ä»½éªŒè¯ç»•è¿‡"
      - "æ•æ„Ÿä¿¡æ¯æ³„éœ²"
    high_issues:
      - "è¾“å…¥éªŒè¯ç¼ºå¤±"
      - "æƒé™æ§åˆ¶ä¸å½“"
      - "åŠ å¯†ç®—æ³•ä¸å®‰å…¨"
      
  Performance_Impact:
    critical_issues:
      - "æ•°æ®åº“N+1æŸ¥è¯¢"
      - "å†…å­˜æ³„éœ²"
      - "é˜»å¡ä¸»çº¿ç¨‹"
    high_issues:
      - "ä½æ•ˆç®—æ³•"
      - "é‡å¤è®¡ç®—"
      - "ç¼“å­˜ç¼ºå¤±"

Error_Handling:
  Repository_Errors:
    clone_failed: "ä»“åº“å…‹éš†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œæƒé™"
    update_failed: "ä»“åº“æ›´æ–°å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨æœ¬åœ°å†²çª"
    branch_not_found: "æŒ‡å®šåˆ†æ”¯ä¸å­˜åœ¨"
    
  API_Errors:
    pr_not_found: "PRä¸å­˜åœ¨æˆ–æ— è®¿é—®æƒé™"
    network_timeout: "ç½‘ç»œè¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•"
    authentication_failed: "CNBè®¤è¯å¤±è´¥"
    
  Analysis_Errors:
    no_changes: "PRæ²¡æœ‰ä»£ç å˜æ›´"
    file_too_large: "æ–‡ä»¶è¿‡å¤§ï¼Œè·³è¿‡åˆ†æ"
    binary_file: "äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè·³è¿‡åˆ†æ"

Performance_Optimization:
  Caching:
    repo_info: "ç¼“å­˜ä»“åº“åŸºæœ¬ä¿¡æ¯"
    analysis_results: "ç¼“å­˜åˆ†æç»“æœé¿å…é‡å¤è®¡ç®—"
    
  Parallel_Processing:
    file_analysis: "å¹¶è¡Œåˆ†æå¤šä¸ªæ–‡ä»¶"
    multiple_checks: "å¹¶è¡Œæ‰§è¡Œä¸åŒç±»å‹æ£€æŸ¥"
    
  Resource_Management:
    memory_limit: "æ§åˆ¶å†…å­˜ä½¿ç”¨é˜²æ­¢OOM"
    timeout_control: "è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´"